#!/bin/bash

# --- Variabel Konfigurasi ---
CONTAINER_NAME="ubuntu20-vpn"
BRIDGE_NAME="lxcbr0"          # Ganti jika Anda menggunakan bridge LXC yang berbeda
CONTAINER_IP="10.0.3.100"     # Ganti IP ini jika diperlukan, pastikan tidak konflik dengan IP lain di bridge Anda
NETMASK="24"
GATEWAY="10.0.3.1"            # Gateway default untuk lxcbr0 (biasanya)

# --- Port yang Akan Di-forward (Tambahkan/Hapus sesuai kebutuhan Anda) ---
# Format: "port_host:port_container/protocol"
# Contoh: "80:80/tcp", "443:443/tcp", "500:500/udp"
PORTS_TO_FORWARD=(
    "443:443/tcp"     # X-Ray, TLS
    "80:80/tcp"       # HAProxy (SSH WebSocket HTTP)
    "109:109/tcp"     # Dropbear
    "143:143/tcp"     # Dropbear (opsional)
    "500:500/udp"     # L2TP/IPsec (IKE)
    "4500:4500/udp"   # L2TP/IPsec (NAT Traversal)
    "1701:1701/udp"   # L2TP
    "1723:1723/tcp"   # PPTP
    "proto_gre"       # PPTP (protokol GRE)
    "8080:8080/tcp"   # HAProxy Stats (opsional)
)

# --- Bagian 1: Instalasi LXC dan Pembuatan Container ---

echo "Memulai setup LXC container dan port forwarding..."

# --- Cek dan Instal LXC jika belum ada ---
LXC_INSTALLED=false
if command -v lxc &> /dev/null && command -v lxc-create &> /dev/null; then
    LXC_INSTALLED=true
    echo "LXC sudah terinstal."
else
    echo "LXC tidak ditemukan. Menginstal LXC dan lxc-templates..."
    sudo apt update
    sudo apt install -y lxc lxc-templates
    if [ $? -ne 0 ]; then
        echo "Gagal menginstal LXC. Mohon periksa koneksi internet atau repository Anda."
        exit 1
    fi
    LXC_INSTALLED=true
    echo "LXC berhasil diinstal."
    echo "Penting: LXC seringkali memerlukan reboot sistem untuk menginisialisasi bridge jaringan dengan benar."
    read -p "Apakah Anda ingin me-reboot sistem Anda sekarang? (y/n): " REBOOT_CHOICE
    if [[ "$REBOOT_CHOICE" =~ ^[Yy]$ ]]; then
        echo "Rebooting sekarang. Mohon jalankan kembali script ini setelah sistem menyala."
        sudo reboot
        exit 0 # Keluar setelah reboot
    else
        echo "Melanjutkan tanpa reboot. Jika Anda mengalami masalah jaringan, pertimbangkan untuk reboot secara manual."
        sleep 5
    fi
fi

# Pastikan LXC sudah benar-benar terinstal dan perintahnya ada
if ! $LXC_INSTALLED; then
    echo "LXC gagal diinstal atau tidak ditemukan. Tidak dapat melanjutkan."
    exit 1
fi

# Cek apakah container sudah ada
if lxc-ls -f | grep -q "$CONTAINER_NAME" && lxc-ls -f | grep -q "STOPPED\|$CONTAINER_NAME.*RUNNING"; then
    echo "Container '$CONTAINER_NAME' sudah ada. Melewati pembuatan container."
else
    echo "Membuat container LXC '$CONTAINER_NAME' dengan Ubuntu 20.04 (Focal Fossa)..."
    sudo lxc-create -t download -n "$CONTAINER_NAME" -- -d ubuntu -r focal -a amd64

    if [ $? -ne 0 ]; then
        echo "Gagal membuat container LXC. Periksa koneksi internet atau konfigurasi LXC Anda."
        exit 1
    fi
fi

echo "Mengkonfigurasi jaringan untuk container '$CONTAINER_NAME'..."
# Stop container jika sedang berjalan untuk mengedit konfigurasi
sudo lxc-stop -n "$CONTAINER_NAME" > /dev/null 2>&1

# Tambahkan konfigurasi jaringan statis ke file konfigurasi container
CONFIG_FILE="/var/lib/lxc/${CONTAINER_NAME}/config"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: File konfigurasi container tidak ditemukan: $CONFIG_FILE"
    exit 1
fi

# Backup file config asli jika belum dibackup
if [ ! -f "${CONFIG_FILE}.bak" ]; then
    sudo cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
    echo "File konfigurasi container asli dibackup ke ${CONFIG_FILE}.bak"
fi

# Pastikan konfigurasi jaringan ada dan tidak duplikat
if ! grep -q "lxc.net.0.ipv4.address = ${CONTAINER_IP}/${NETMASK}" "$CONFIG_FILE"; then
    sudo bash -c "cat <<EOF >> $CONFIG_FILE
lxc.net.0.ipv4.address = ${CONTAINER_IP}/${NETMASK}
lxc.net.0.ipv4.gateway = ${GATEWAY}
lxc.net.0.link = ${BRIDGE_NAME}
lxc.net.0.type = veth
lxc.net.0.flags = up
EOF"
    echo "Konfigurasi IP statis ditambahkan untuk ${CONTAINER_IP}."
else
    echo "Konfigurasi IP statis sudah ada di file config container."
fi

echo "Memulai container '$CONTAINER_NAME'..."
sudo lxc-start -n "$CONTAINER_NAME" -d
sleep 10 # Beri waktu agar container boot sepenuhnya

# Cek apakah container berjalan
if ! lxc-ls -f "$CONTAINER_NAME" | grep -q "RUNNING"; then
    echo "Gagal memulai container '$CONTAINER_NAME'. Periksa log LXC di /var/log/lxc/${CONTAINER_NAME}.log."
    exit 1
fi

echo "Container '$CONTAINER_NAME' sudah berjalan dengan IP: ${CONTAINER_IP}"

echo "Menunggu container mendapatkan koneksi internet..."
# Coba ping google dari dalam container untuk memastikan koneksi internet
sudo lxc-attach -n "$CONTAINER_NAME" -- ping -c 3 google.com > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Container tidak memiliki koneksi internet. Periksa konfigurasi jaringan host dan LXC Anda."
    echo "Jika Anda tidak reboot setelah instalasi LXC, coba reboot host secara manual sekarang."
    exit 1
fi

echo "Mengupdate dan mengupgrade sistem di dalam container..."
sudo lxc-attach -n "$CONTAINER_NAME" -- apt update && sudo lxc-attach -n "$CONTAINER_NAME" -- apt upgrade -y

---

### Konfigurasi IP Forwarding dan Port Forwarding (DNAT) di Host

echo "Mengkonfigurasi IP Forwarding dan Port Forwarding di host Ubuntu 24.04..."

# Aktifkan IP Forwarding di Host
echo "Mengaktifkan IP Forwarding di host..."
if ! grep -q "net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
else
    sudo sed -i 's/^#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
fi
sudo sysctl -p

# Instal iptables-persistent untuk menyimpan aturan firewall
echo "Menginstal iptables-persistent untuk menyimpan aturan firewall..."
sudo apt install -y iptables-persistent

# Temukan interface internet utama di host
HOST_INTERNET_INTERFACE=$(ip route get 8.8.8.8 | awk '{print $5}' | head -n 1)
if [ -z "$HOST_INTERNET_INTERFACE" ]; then
    echo "Tidak dapat menemukan interface internet utama host. Mohon tentukan secara manual."
    echo "Anda bisa mencari interface dengan 'ip a' atau 'ip route'."
    exit 1
fi
echo "Interface internet host terdeteksi: $HOST_INTERNET_INTERFACE"

echo "Menambahkan aturan IPTables untuk port forwarding..."

# Hapus aturan NAT yang sudah ada untuk menghindari duplikasi
echo "Membersihkan aturan NAT yang mungkin duplikat..."
# Loop melalui semua aturan DNAT yang mungkin sudah ada untuk container_ip dan hapus
for rule in $(sudo iptables -t nat -S PREROUTING | grep "DNAT --to-destination ${CONTAINER_IP}"); do
    sudo iptables -t nat -D $(echo "$rule" | sed 's/-A //')
done

# Hapus aturan FORWARD yang mungkin duplikat
for rule in $(sudo iptables -S FORWARD | grep "${BRIDGE_NAME} -o ${HOST_INTERNET_INTERFACE}"); do
    sudo iptables -D $(echo "$rule" | sed 's/-A //')
done
for rule in $(sudo iptables -S FORWARD | grep "${HOST_INTERNET_INTERFACE} -o ${BRIDGE_NAME}"); do
    sudo iptables -D $(echo "$rule" | sed 's/-A //')
done
# Aturan GRE forward juga perlu dibersihkan secara spesifik
for rule in $(sudo iptables -S FORWARD | grep "proto 47 -d ${CONTAINER_IP}"); do
    sudo iptables -D $(echo "$rule" | sed 's/-A //')
done

# Izinkan forwarding dari bridge LXC ke internet
echo "Menambahkan aturan FORWARD untuk lalu lintas LXC..."
sudo iptables -A FORWARD -i "$BRIDGE_NAME" -o "$HOST_INTERNET_INTERFACE" -j ACCEPT
sudo iptables -A FORWARD -i "$HOST_INTERNET_INTERFACE" -o "$BRIDGE_NAME" -m state --state RELATED,ESTABLISHED -j ACCEPT

# Aturan NAT untuk lalu lintas keluar dari container
echo "Menambahkan aturan MASQUERADE untuk container..."
sudo iptables -t nat -A POSTROUTING -o "$HOST_INTERNET_INTERFACE" -j MASQUERADE

# Aturan DNAT (Port Forwarding)
for port_rule in "${PORTS_TO_FORWARD[@]}"; do
    IFS='/' read -r PORT_SPECS PROTOCOL <<< "$port_rule"

    if [ "$PROTOCOL" == "proto_gre" ]; then
        echo "  - Meneruskan protokol GRE ke ${CONTAINER_IP}"
        sudo iptables -t nat -A PREROUTING -p gre -j DNAT --to-destination "${CONTAINER_IP}"
        sudo iptables -A FORWARD -p gre -d "${CONTAINER_IP}" -j ACCEPT
    else
        IFS=':' read -r HOST_PORT CONTAINER_PORT <<< "$PORT_SPECS"
        echo "  - Meneruskan port ${HOST_PORT}/${PROTOCOL} ke ${CONTAINER_IP}:${CONTAINER_PORT}"
        sudo iptables -t nat -A PREROUTING -p "$PROTOCOL" --dport "$HOST_PORT" -j DNAT --to-destination "${CONTAINER_IP}:${CONTAINER_PORT}"
        sudo iptables -A FORWARD -p "$PROTOCOL" -d "${CONTAINER_IP}" --dport "$CONTAINER_PORT" -j ACCEPT
    fi
done

# Simpan aturan iptables agar tetap persisten setelah reboot
echo "Menyimpan aturan IPTables..."
sudo netfilter-persistent save

echo "Setup LXC container dan port forwarding selesai!"
echo "Container '$CONTAINER_NAME' berjalan dengan IP: ${CONTAINER_IP}"
echo "Port-port berikut telah diforward dari host ke container:"
for port_rule in "${PORTS_TO_FORWARD[@]}"; do
    IFS='/' read -r PORT_SPECS PROTOCOL <<< "$port_rule"
    if [ "$PROTOCOL" == "proto_gre" ]; then
        echo "  - Protokol GRE"
    else
        echo "  - ${PORT_SPECS} (${PROTOCOL})"
    fi
done

echo "Anda sekarang dapat menjalankan script X-Ray dan layanan lainnya di dalam container."
echo "Untuk masuk ke container: sudo lxc-attach -n ${CONTAINER_NAME}"
echo "Penting: Pastikan juga tidak ada firewall lain (misalnya UFW) di host Anda yang memblokir port-port ini."
echo "Jika Anda menggunakan UFW, pastikan Anda menambahkan aturan 'ufw allow' untuk setiap port yang Anda forward."
